results_per_pid_dir="/icgc/dkfzlsdf/analysis/OE0290_projects/pediatric_tumor/exon_sequencing/results_per_pid"

PIDs="OE0290-PED_1LB-001 OE0290-PED_1LB-002 OE0290-PED_1LB-003 OE0290-PED_1LB-004 OE0290-PED_1LB-005 OE0290-PED_1LB-006 OE0290-PED_1LB-007 OE0290-PED_1LB-008 OE0290-PED_1LB-009 OE0290-PED_1LB-010 OE0290-PED_1LB-011 OE0290-PED_1LB-012 OE0290-PED_1LB-013 OE0290-PED_1LB-014 OE0290-PED_1LB-015 OE0290-PED_1LB-016 OE0290-PED_1LB-017 OE0290-PED_1LB-018 OE0290-PED_1LB-019 OE0290-PED_1LB-020 OE0290-PED_1LB-021 OE0290-PED_1LB-022 OE0290-PED_1LB-023 OE0290-PED_1LB-024 OE0290-PED_1LB-025 OE0290-PED_1LB-026 OE0290-PED_1LB-027 OE0290-PED_1LB-028 OE0290-PED_1LB-029 OE0290-PED_1LB-030 OE0290-PED_1LB-031 OE0290-PED_1LB-033 OE0290-PED_1LB-042 OE0290-PED_1LB-044 OE0290-PED_1LB-045 OE0290-PED_1LB-046 OE0290-PED_1LB-047 OE0290-PED_1LB-048 OE0290-PED_1LB-053 OE0290-PED_1LB-054 OE0290-PED_1LB-056 OE0290-PED_1LB-059 OE0290-PED_1LB-060 OE0290-PED_1LB-064 OE0290-PED_1LB-066 OE0290-PED_1LB-069 OE0290-PED_2LB-001 OE0290-PED_2LB-002 OE0290-PED_2LB-003 OE0290-PED_2LB-005 OE0290-PED_2LB-006 OE0290-PED_2LB-007 OE0290-PED_2LB-008 OE0290-PED_2LB-009 OE0290-PED_2LB-010 OE0290-PED_2LB-011 OE0290-PED_2LB-012 OE0290-PED_2LB-013 OE0290-PED_2LB-014 OE0290-PED_2LB-015 OE0290-PED_2LB-016 OE0290-PED_2LB-017 OE0290-PED_2LB-018 OE0290-PED_2LB-019 OE0290-PED_2LB-020 OE0290-PED_2LB-021 OE0290-PED_2LB-022 OE0290-PED_2LB-023 OE0290-PED_2LB-024 OE0290-PED_2LB-025 OE0290-PED_2LB-026 OE0290-PED_2LB-027 OE0290-PED_2LB-028 OE0290-PED_2LB-029 OE0290-PED_2LB-030 OE0290-PED_2LB-031 OE0290-PED_2LB-032 OE0290-PED_2LB-033 OE0290-PED_2LB-034 OE0290-PED_2LB-035 OE0290-PED_2LB-036 OE0290-PED_2LB-037 OE0290-PED_2LB-038 OE0290-PED_2LB-039 OE0290-PED_2LB-040 OE0290-PED_2LB-041 OE0290-PED_2LB-042 OE0290-PED_2LB-043 OE0290-PED_2LB-044 OE0290-PED_2LB-045 OE0290-PED_2LB-046 OE0290-PED_2LB-047 OE0290-PED_2LB-048 OE0290-PED_2LB-049 OE0290-PED_2LB-050 OE0290-PED_2LB-051 OE0290-PED_2LB-052 OE0290-PED_2LB-053 OE0290-PED_2LB-054 OE0290-PED_2LB-055 OE0290-PED_2LB-056 OE0290-PED_2LB-057 OE0290-PED_2LB-058 OE0290-PED_2LB-059 OE0290-PED_2LB-060 OE0290-PED_2LB-061 OE0290-PED_2LB-062 OE0290-PED_2LB-063 OE0290-PED_2LB-064 OE0290-PED_2LB-065 OE0290-PED_2LB-066 OE0290-PED_2LB-067 OE0290-PED_2LB-068 OE0290-PED_2LB-069 OE0290-PED_2LB-070 OE0290-PED_2LB-071 OE0290-PED_2LB-072 OE0290-PED_2LB-073 OE0290-PED_2LB-074 OE0290-PED_2LB-075 OE0290-PED_2LB-076 OE0290-PED_2LB-077 OE0290-PED_2LB-078 OE0290-PED_2LB-079 OE0290-PED_2LB-080 OE0290-PED_2LB-081 OE0290-PED_2LB-082 OE0290-PED_2LB-083 OE0290-PED_2LB-084 OE0290-PED_2LB-085 OE0290-PED_2LB-086 OE0290-PED_2LB-087 OE0290-PED_2LB-088 OE0290-PED_2LB-089 OE0290-PED_2LB-090 OE0290-PED_2LB-091 OE0290-PED_2LB-092 OE0290-PED_2LB-093 OE0290-PED_2LB-094 OE0290-PED_2LB-095 OE0290-PED_2LB-096 OE0290-PED_2LB-097 OE0290-PED_2LB-098 OE0290-PED_2LB-099 OE0290-PED_2LB-100 OE0290-PED_2LB-101 OE0290-PED_2LB-102 OE0290-PED_2LB-103 OE0290-PED_2LB-104 OE0290-PED_2LB-105 OE0290-PED_2LB-106 OE0290-PED_2LB-108 OE0290-PED_2LB-109 OE0290-PED_2LB-110 OE0290-PED_2LB-111 OE0290-PED_2LB-112 OE0290-PED_2LB-113 OE0290-PED_2LB-116 OE0290-PED_2LB-117 OE0290-PED_2LB-118 OE0290-PED_2LB-119 OE0290-PED_2LB-120 OE0290-PED_2LB-121 OE0290-PED_2LB-122 OE0290-PED_2LB-123 OE0290-PED_2LB-124 OE0290-PED_2LB-125 OE0290-PED_2LB-126 OE0290-PED_2LB-127 OE0290-PED_2LB-128 OE0290-PED_2LB-129 OE0290-PED_2LB-130 OE0290-PED_2LB-131 OE0290-PED_2LB-132 OE0290-PED_2LB-133 OE0290-PED_2LB-134 OE0290-PED_3LB-002 OE0290-PED_3LB-003 OE0290-PED_3LB-004 OE0290-PED_3LB-005 OE0290-PED_3LB-006 OE0290-PED_4LB-002 OE0290-PED_4LB-003 OE0290-PED_4LB-004 OE0290-PED_4LB-005 OE0290-PED_4LB-006 OE0290-PED_4LB-008 OE0290-PED_5LB-001 OE0290-PED_5LB-002 OE0290-PED_5LB-004 OE0290-PED_5LB-005 OE0290-PED_5LB-006 OE0290-PED_5LB-007 OE0290-PED_5LB-008 OE0290-PED_5LB-009 OE0290-PED_5LB-011 OE0290-PED_5LB-012 OE0290-PED_5LB-013 OE0290-PED_5LB-014 OE0290-PED_5LB-015 OE0290-PED_5LB-016 OE0290-PED_5LB-017 OE0290-PED_5LB-018 OE0290-PED_5LB-019 OE0290-PED_5LB-020 OE0290-PED_5LB-021 OE0290-PED_5LB-022 OE0290-PED_5LB-024 OE0290-PED_5LB-025 OE0290-PED_5LB-026 OE0290-PED_5LB-027 OE0290-PED_5LB-034 OE0290-PED_5LB-045 OE0290-PED_5LB-064"

intervals="/icgc/dkfzlsdf/analysis/OE0290_projects/pediatric_tumor/exon_sequencing/processing_scripts/PureCN/target_beds/Agilent7withoutUTRs_plain_bait.intervals"

bsub_option_small="#!/bin/bash\n#BSUB -q verylong\n#BSUB -R \"rusage[mem=20GB]\"\n"

for PID in ${PIDs}; do
	pid_dir="${results_per_pid_dir}/${PID}/"
	if [ ! -d ${pid_dir} ]; then
		echo "PID ${PID} not found (Skip)"
		continue
	fi

	bamfiles=$(find ${pid_dir}/alignment -name "plasma-*.mdup.bam" -o -name "csf-*.mdup.bam" -o -name "serum-*.mdup.bam" -o -name "bone*.mdup.bam")
	PureCN_dir="${pid_dir}/PureCN"
	for bamfile in ${bamfiles}; do 
        	if [ ! -d ${PureCN_dir} ]; then 
                	mkdir ${PureCN_dir}
        	fi
		
		##### Extract sample ID from bamfile name
		sample_id=$(basename ${bamfile} | cut -f1,2,3 -d"_")
		#####

		output_dir=${PureCN_dir}/${sample_id}/
		[ ! -d ${output_dir} ] && mkdir ${output_dir}
                

		bsubExecution_dir=${output_dir}/bsubExecutionfiles/
		[ ! -d "${bsubExecution_dir}" ] && mkdir "${bsubExecution_dir}"

		module_load_cmd="module load R/3.6.0;"
		coverage_cmd="Rscript ~/R/x86_64-pc-linux-gnu-library/3.6/PureCN/extdata/Coverage.R --outdir ${output_dir} --bam ${bamfile} --intervals ${intervals} --removemapq0 --force"

		echo -e ${bsub_option_small} ${module_load_cmd} ${coverage_cmd} > ${bsubExecution_dir}/GC-normalied_coverage.sh

		coverage_job_id=$(bsub -J ${sample_id}_GC-normalied_coverage  < ${bsubExecution_dir}/GC-normalied_coverage.sh | awk '/is submitted/{print substr($2, 2, length($2)-2);}')
		echo "Submit ${sample_id}_GC-normalied_coverage : job id ${coverage_job_id}"

	done
	
done
echo -e "Done\n"

